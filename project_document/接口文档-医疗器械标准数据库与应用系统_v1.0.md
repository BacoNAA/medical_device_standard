# 医疗器械标准内容信息化数据库及运用系统——接口文档

**文档版本：** v2.0
**编制日期：** 2025-11-14
**文档状态：** 正式版（基于实际项目配置更新）
**后端技术栈：** Spring Boot 3.5.7 + Java 17 + MyBatis-Plus 3.5.9
**前端技术栈：** Vue 3.3.4 + Element Plus 2.4.2 + Vite 4.4.9

---

## 目录

[1. 引言](#1-引言)  
&nbsp;&nbsp;[1.1 编写目的](#11-编写目的)  
&nbsp;&nbsp;[1.2 项目背景](#12-项目背景)  
&nbsp;&nbsp;[1.3 定义](#13-定义)  
&nbsp;&nbsp;[1.4 参考资料](#14-参考资料)  

[2. 接口概述](#2-接口概述)  
&nbsp;&nbsp;[2.1 接口规范](#21-接口规范)  
&nbsp;&nbsp;[2.2 通用说明](#22-通用说明)  
&nbsp;&nbsp;[2.3 认证机制](#23-认证机制)  
&nbsp;&nbsp;[2.4 错误码定义](#24-错误码定义)  

[3. 用户管理接口](#3-用户管理接口)  
&nbsp;&nbsp;[3.1 用户登录](#31-用户登录)  
&nbsp;&nbsp;[3.2 用户登出](#32-用户登出)  
&nbsp;&nbsp;[3.3 获取用户信息](#33-获取用户信息)  
&nbsp;&nbsp;[3.4 修改密码](#34-修改密码)  
&nbsp;&nbsp;[3.5 用户列表查询](#35-用户列表查询)  
&nbsp;&nbsp;[3.6 创建用户](#36-创建用户)  
&nbsp;&nbsp;[3.7 更新用户](#37-更新用户)  
&nbsp;&nbsp;[3.8 删除用户](#38-删除用户)  

[4. 标准数据管理接口](#4-标准数据管理接口)  
&nbsp;&nbsp;[4.1 标准列表查询](#41-标准列表查询)  
&nbsp;&nbsp;[4.2 标准详情查询](#42-标准详情查询)  
&nbsp;&nbsp;[4.3 标准搜索](#43-标准搜索)  
&nbsp;&nbsp;[4.4 标准导入](#44-标准导入)  
&nbsp;&nbsp;[4.5 标准更新](#45-标准更新)  
&nbsp;&nbsp;[4.6 标准删除](#46-标准删除)  
&nbsp;&nbsp;[4.7 检验项目查询](#47-检验项目查询)  
&nbsp;&nbsp;[4.8 检验方法查询](#48-检验方法查询)  

[5. 设备管理接口](#5-设备管理接口)  
&nbsp;&nbsp;[5.1 设备目录查询](#51-设备目录查询)  
&nbsp;&nbsp;[5.2 设备详情查询](#52-设备详情查询)  
&nbsp;&nbsp;[5.3 设备搜索](#53-设备搜索)  
&nbsp;&nbsp;[5.4 设备创建](#54-设备创建)  
&nbsp;&nbsp;[5.5 设备更新](#55-设备更新)  
&nbsp;&nbsp;[5.6 设备删除](#56-设备删除)  
&nbsp;&nbsp;[5.7 项目设备关联查询](#57-项目设备关联查询)  

[6. 错误报告接口](#6-错误报告接口)  
&nbsp;&nbsp;[6.1 错误报告列表](#61-错误报告列表)  
&nbsp;&nbsp;[6.2 错误报告详情](#62-错误报告详情)  
&nbsp;&nbsp;[6.3 提交错误报告](#63-提交错误报告)  
&nbsp;&nbsp;[6.4 处理错误报告](#64-处理错误报告)  
&nbsp;&nbsp;[6.5 关闭错误报告](#65-关闭错误报告)  

[7. 数据导出接口](#7-数据导出接口)  
&nbsp;&nbsp;[7.1 表格1导出](#71-表格1导出)  
&nbsp;&nbsp;[7.2 表格2导出](#72-表格2导出)  
&nbsp;&nbsp;[7.3 表格3导出](#73-表格3导出)  
&nbsp;&nbsp;[7.4 自定义模板导出](#74-自定义模板导出)  
&nbsp;&nbsp;[7.5 导出模板管理](#75-导出模板管理)  
&nbsp;&nbsp;[7.6 导出历史查询](#76-导出历史查询)  

[8. PTR编辑接口](#8-ptr编辑接口)  
&nbsp;&nbsp;[8.1 获取模板列表](#81-获取模板列表)  
&nbsp;&nbsp;[8.2 插入模板内容](#82-插入模板内容)  
&nbsp;&nbsp;[8.3 智能内容推荐](#83-智能内容推荐)  
&nbsp;&nbsp;[8.4 保存PTR文档](#84-保存ptr文档)  

[9. 系统管理接口](#9-系统管理接口)  
&nbsp;&nbsp;[9.1 操作日志查询](#91-操作日志查询)  
&nbsp;&nbsp;[9.2 系统配置查询](#92-系统配置查询)  
&nbsp;&nbsp;[9.3 系统配置更新](#93-系统配置更新)  

---

## 1. 引言

### 1.1 编写目的

本文档是医疗器械标准内容信息化数据库及运用系统的接口文档，详细描述系统前后端交互的API接口规范。

本文档的目的是：
- 定义前后端交互的接口规范和数据格式
- 为前端开发提供接口调用说明
- 为后端开发提供接口实现规范
- 为接口测试提供依据

本文档供前端开发人员、后端开发人员、测试人员参考。

### 1.2 项目背景

（参考需求规格说明书）

### 1.3 定义

| 术语 | 定义 |
|------|------|
| API | Application Programming Interface，应用程序接口 |
| REST | Representational State Transfer，表述性状态传递 |
| HTTP | HyperText Transfer Protocol，超文本传输协议 |
| JSON | JavaScript Object Notation，JavaScript对象表示法 |
| JWT | JSON Web Token，用于身份认证的令牌 |
| CRUD | Create, Read, Update, Delete，增删改查操作 |

### 1.4 参考资料

- 《需求规格说明书-医疗器械标准数据库与应用系统 v4.0》
- 《系统设计说明书-医疗器械标准数据库与应用系统 v1.0》
- 《数据库设计文档-医疗器械标准数据库与应用系统 v1.0》

---

## 2. 接口概述

### 2.1 接口规范

#### 2.1.1 协议规范

- 协议：HTTP/HTTPS
- 数据格式：JSON
- 字符编码：UTF-8
- 接口风格：RESTful API

#### 2.1.2 请求方法

| 方法 | 说明 | 使用场景 |
|------|------|----------|
| GET | 查询资源 | 获取数据、列表查询 |
| POST | 创建资源 | 新增数据、登录、复杂查询 |
| PUT | 更新资源（全量） | 完整更新数据 |
| PATCH | 更新资源（部分） | 部分更新数据 |
| DELETE | 删除资源 | 删除数据 |

#### 2.1.3 URL规范

```
{protocol}://{host}:{port}/api/{version}/{module}/{resource}
```

示例：
```
https://api.example.com/api/v1/standards/list
```

### 2.2 通用说明

#### 2.2.1 请求头（Request Headers）

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | String | 是 | 内容类型，固定值：application/json |
| Authorization | String | 否 | 认证令牌，格式：Bearer {token} |
| X-Request-ID | String | 否 | 请求唯一标识，用于追踪 |

#### 2.2.2 响应格式

**成功响应：**

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1699776000000
}
```

**失败响应：**

```json
{
  "code": 400,
  "message": "参数错误",
  "data": null,
  "timestamp": 1699776000000
}
```

#### 2.2.3 分页参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | Integer | 否 | 1 | 页码，从1开始 |
| pageSize | Integer | 否 | 10 | 每页数量 |

**分页响应格式：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "totalPages": 10
  },
  "timestamp": 1699776000000
}
```

### 2.3 认证机制

**认证方式：** JWT（JSON Web Token）

**认证流程：**

1. 用户调用登录接口（POST /api/v1/auth/login），提交用户名和密码
2. 后端验证成功后，生成JWT令牌并返回
3. 前端将令牌存储到localStorage
4. 后续所有请求在HTTP Header中携带令牌：`Authorization: Bearer {token}`
5. 后端拦截器验证令牌有效性和过期时间
6. 令牌过期后需重新登录

**令牌有效期：** 8小时

**角色自动识别：** 系统根据用户名格式自动识别角色类型（RoleType）：
- `dataadmin` → RoleType = 1（数据输入员）
- `sysadmin` → RoleType = 2（系统管理员）
- `yw###` → RoleType = 3（业务人员）
- `zl###` → RoleType = 4（质量管理人员）
- `sb###` → RoleType = 5（设备管理人员）
- `sy###` → RoleType = 6（实验室人员）

### 2.4 错误码定义

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 200 | 成功 | - |
| 400 | 请求参数错误 | 检查请求参数格式和必填项 |
| 401 | 未授权（未登录或令牌失效） | 跳转到登录页 |
| 403 | 无权限访问 | 提示用户权限不足 |
| 404 | 资源不存在 | 检查请求路径和资源ID |
| 409 | 数据冲突（如重复导入） | 提示用户数据已存在 |
| 500 | 服务器内部错误 | 联系管理员 |
| 1001 | 用户名或密码错误 | 提示用户重新输入 |
| 1002 | 账户已锁定 | 提示用户联系管理员 |
| 1003 | Token已过期 | 跳转到登录页 |
| 2001 | 文件格式不支持 | 提示用户上传.xlsx格式文件 |
| 2002 | 文件大小超限 | 提示用户文件不能超过10MB |
| 2003 | 标准编号格式错误 | 提示用户标准编号必须包含年代号 |
| 2004 | 标准编号已存在 | 提示用户该标准已导入 |
| 2005 | Excel解析失败 | 检查Excel文件格式和内容 |
| 3001 | 设备编号已存在 | 提示用户设备编号重复 |
| 3002 | 设备不存在 | 检查设备编号 |

---

## 3. 用户管理接口

### 3.1 用户登录 ⭐ 核心接口

**接口地址：** `POST /api/v1/auth/login`

**业务说明：**
- 用户登录系统，验证用户名和密码
- 系统根据用户名格式自动识别角色类型（RoleType）
- 登录成功后返回JWT令牌和用户信息（包含roleType）
- 前端根据roleType进行路由跳转和菜单渲染

**请求参数（Request Body）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| username | String | 是 | 用户名 | dataadmin |
| password | String | 是 | 密码（明文） | 123456 |

**请求示例：**

```json
{
  "username": "dataadmin",
  "password": "123456"
}
```

**响应参数（Response Data）：**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| token | String | JWT令牌，有效期8小时 |
| userInfo | Object | 用户信息对象 |
| userInfo.userId | Integer | 用户ID |
| userInfo.username | String | 用户名 |
| userInfo.realName | String | 真实姓名 |
| userInfo.roleType | Integer | 角色类型（1-6） |
| userInfo.roleName | String | 角色名称 |
| userInfo.department | String | 所属部门 |
| userInfo.email | String | 邮箱 |
| userInfo.phone | String | 联系电话 |

**响应示例（成功）：**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiZGF0YWFkbWluIiwicm9sZVR5cGUiOjEsImV4cCI6MTY5OTkwNDAwMH0.abc123xyz",
    "userInfo": {
      "userId": 1,
      "username": "dataadmin",
      "realName": "张三",
      "roleType": 1,
      "roleName": "数据输入员",
      "department": "质量管理部",
      "email": "zhangsan@example.com",
      "phone": "13800138000"
    }
  },
  "timestamp": 1699876543210
}
```

**响应示例（失败 - 用户名或密码错误）：**

```json
{
  "code": 1001,
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": 1699876543210
}
```

**响应示例（失败 - 账户已锁定）：**

```json
{
  "code": 1002,
  "message": "账户已锁定，请联系管理员",
  "data": null,
  "timestamp": 1699876543210
}
```

**角色类型（roleType）枚举值：**

| roleType | roleName | 账号格式 | 前端路由跳转 |
|----------|----------|----------|--------------|
| 1 | 数据输入员 | dataadmin | /standards/import |
| 2 | 系统管理员 | sysadmin | /system/users |
| 3 | 业务人员 | yw### | /standards/list |
| 4 | 质量管理人员 | zl### | /standards/list |
| 5 | 设备管理人员 | sb### | /equipment/list |
| 6 | 实验室人员 | sy### | /standards/list |

**前端处理逻辑：**

```javascript
// 登录成功后
const { token, userInfo } = response.data;

// 1. 存储token到localStorage
localStorage.setItem('token', token);
localStorage.setItem('userInfo', JSON.stringify(userInfo));

// 2. 根据roleType跳转到对应首页
switch (userInfo.roleType) {
  case 1: // 数据输入员
    router.push('/standards/import');
    break;
  case 2: // 系统管理员
    router.push('/system/users');
    break;
  case 3: // 业务人员
  case 4: // 质量管理人员
  case 6: // 实验室人员
    router.push('/standards/list');
    break;
  case 5: // 设备管理人员
    router.push('/equipment/list');
    break;
}

// 3. 根据roleType动态渲染菜单
renderMenuByRole(userInfo.roleType);
```

**注意事项：**
1. 密码传输建议使用HTTPS加密
2. 登录失败5次后锁定账户30分钟
3. token过期后需重新登录
4. roleType由后端根据username格式自动识别，前端不可修改

### 3.2 用户登出

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 3.3 获取用户信息

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 3.4 修改密码

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 3.5 用户列表查询

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 3.6 创建用户

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 3.7 更新用户

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 3.8 删除用户

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

---

## 4. 标准数据管理接口

### 4.1 标准列表查询

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 4.2 标准导入预览接口 ⭐⭐⭐ 核心接口（最复杂）

**接口地址：** `POST /api/v1/standards/import/preview`

**业务说明：**
- 这是全系统最复杂的交互接口
- 用户上传Excel文件后，后端解析并返回预览数据
- 系统自动识别设备关键词，判定红/黄/绿状态
- 前端根据status字段进行颜色高亮显示
- 用户确认后调用确认导入接口（POST /api/v1/standards/import/confirm）

**请求参数（multipart/form-data）：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | Excel文件（.xlsx格式，最大10MB） |

**请求示例（cURL）：**

```bash
curl -X POST "http://localhost:8080/api/v1/standards/import/preview" \
  -H "Authorization: Bearer {token}" \
  -F "file=@GB15810-2019.xlsx"
```

**响应参数（Response Data）：**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| standardInfo | Object | 标准基本信息 |
| standardInfo.standardNo | String | 标准编号（含年代号） |
| standardInfo.standardName | String | 标准名称 |
| standardInfo.publishDate | String | 发布日期（YYYY-MM-DD） |
| standardInfo.effectiveDate | String | 实施日期（YYYY-MM-DD） |
| items | Array | 检验项目列表（核心数据） |
| items[].itemId | Integer | 项目ID（临时ID，确认导入后生成真实ID） |
| items[].clauseNo | String | 项目条款号（如"5.7.1"） |
| items[].itemName | String | 项目名称（如"残留容量"） |
| items[].requirement | String | 项目要求内容 |
| items[].methodContent | String | 检验方法内容 |
| items[].methodType | Integer | 方法类型（1=无独立方法，2=引用附录，3=完整方法） |
| items[].equipmentCode | String | 识别到的设备编号（如"A001"，未识别则为null） |
| items[].equipmentName | String | 识别到的设备名称（如"电子天平"） |
| items[].specificationRequirement | String | 规格要求（如"分度值0.1mg"） |
| items[].status | Integer | **解析状态（关键字段）** |
| items[].statusColor | String | **状态颜色（前端高亮用）** |
| items[].warningMsg | String | **警告/错误信息（前端显示用）** |
| items[].equipmentMatch | Object | **识别到的设备对象（未识别则为null）** |
| items[].equipmentMatch.equipmentCode | String | 设备编号 |
| items[].equipmentMatch.equipmentName | String | 设备名称 |
| items[].equipmentMatch.category | String | 设备类别 |
| statistics | Object | 统计信息 |
| statistics.total | Integer | 总项目数 |
| statistics.successCount | Integer | 成功识别数（绿色） |
| statistics.warningCount | Integer | 需确认数（黄色） |
| statistics.errorCount | Integer | 需人工补充数（红色） |

**status状态码定义（关键）：**

| status | statusColor | 说明 | warningMsg示例 | 前端处理 |
|--------|-------------|------|----------------|----------|
| 1 | green | 成功：设备已存在，自动关联成功 | "自动识别成功" | 绿色高亮，无需人工处理 |
| 2 | yellow | 警告：识别到新设备，需用户确认 | "识别到新设备：高精度测量仪，请确认是否添加到设备库" | 黄色高亮，需用户确认 |
| 3 | red | 错误：未识别到设备或缺少方法内容 | "未识别到设备关键词，请人工补充设备信息" 或 "缺少方法内容，请补充" | 红色高亮，需人工补充 |

**响应示例（成功）：**

```json
{
  "code": 200,
  "message": "解析成功",
  "data": {
    "standardInfo": {
      "standardNo": "GB 15810-2019",
      "standardName": "一次性使用无菌注射器",
      "publishDate": "2019-05-10",
      "effectiveDate": "2020-05-01"
    },
    "items": [
      {
        "itemId": 1,
        "clauseNo": "5.7.1",
        "itemName": "残留容量",
        "requirement": "残留容量应不大于标称容量的5%...",
        "methodContent": "使用分度值0.1mg的电子天平称量...",
        "methodType": 3,
        "equipmentCode": "A001",
        "equipmentName": "电子天平",
        "specificationRequirement": "分度值0.1mg",
        "status": 1,
        "statusColor": "green",
        "warningMsg": "自动识别成功",
        "equipmentMatch": {
          "equipmentCode": "A001",
          "equipmentName": "电子天平",
          "category": "天平类"
        }
      },
      {
        "itemId": 2,
        "clauseNo": "5.7.2",
        "itemName": "器身密合性",
        "requirement": "器身密合性应符合附录B中B.2的要求",
        "methodContent": "使用高精度测量仪进行测试...",
        "methodType": 2,
        "equipmentCode": null,
        "equipmentName": "高精度测量仪",
        "specificationRequirement": null,
        "status": 2,
        "statusColor": "yellow",
        "warningMsg": "识别到新设备：高精度测量仪，请确认是否添加到设备库",
        "equipmentMatch": null
      },
      {
        "itemId": 3,
        "clauseNo": "5.7.3",
        "itemName": "滑动性能",
        "requirement": "滑动性能应符合要求",
        "methodContent": "",
        "methodType": 1,
        "equipmentCode": null,
        "equipmentName": null,
        "specificationRequirement": null,
        "status": 3,
        "statusColor": "red",
        "warningMsg": "缺少方法内容，请人工补充",
        "equipmentMatch": null
      }
    ],
    "statistics": {
      "total": 42,
      "successCount": 35,
      "warningCount": 5,
      "errorCount": 2
    }
  },
  "timestamp": 1699876543210
}
```

**响应示例（失败 - 文件格式错误）：**

```json
{
  "code": 2001,
  "message": "文件格式不支持，仅支持.xlsx格式",
  "data": null,
  "timestamp": 1699876543210
}
```

**响应示例（失败 - Excel解析失败）：**

```json
{
  "code": 2005,
  "message": "Excel解析失败：缺少必需工作表'标准信息'",
  "data": null,
  "timestamp": 1699876543210
}
```

**前端处理逻辑：**

```javascript
// 1. 上传文件
const formData = new FormData();
formData.append('file', file);

const response = await axios.post('/api/v1/standards/import/preview', formData, {
  headers: {
    'Content-Type': 'multipart/form-data',
    'Authorization': `Bearer ${token}`
  }
});

// 2. 渲染预览表格
const { standardInfo, items, statistics } = response.data.data;

// 3. 根据status进行颜色高亮
items.forEach(item => {
  switch (item.status) {
    case 1: // 绿色：成功
      item.rowClass = 'success-row';
      break;
    case 2: // 黄色：警告
      item.rowClass = 'warning-row';
      break;
    case 3: // 红色：错误
      item.rowClass = 'error-row';
      break;
  }
});

// 4. 显示统计信息
console.log(`总计：${statistics.total}，成功：${statistics.successCount}，警告：${statistics.warningCount}，错误：${statistics.errorCount}`);

// 5. 用户确认后调用确认导入接口
const confirmImport = async () => {
  await axios.post('/api/v1/standards/import/confirm', {
    standardInfo,
    items: items.map(item => ({
      ...item,
      // 用户可能修改了设备信息
      equipmentCode: item.equipmentCode,
      equipmentName: item.equipmentName,
      specificationRequirement: item.specificationRequirement
    }))
  });
};
```

**注意事项：**
1. 文件大小限制：10MB
2. 仅支持.xlsx格式
3. Excel必须包含"标准信息"和"检验要求"工作表
4. status字段是前端渲染的关键，必须严格按照1/2/3进行判断
5. warningMsg用于前端tooltip或提示信息显示
6. equipmentMatch为null时表示未识别到设备
7. 前端需要支持用户修改黄色和红色行的设备信息
8. 确认导入前需校验所有红色行是否已补充完整

### 4.3 标准详情查询 ⭐ 核心接口

**接口地址：** `GET /api/v1/standards/{standardNo}`

**业务说明：**
- 查询标准的完整详情信息
- 返回深层嵌套结构：标准 → 检验项目 → 关联设备
- 前端一次性获取所有数据，用于详情页渲染
- 必须包含SpecificationRequirement字段（规格要求）

**请求参数（Path Variable）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| standardNo | String | 是 | 标准编号（URL编码） | GB%2015810-2019 |

**请求示例：**

```
GET /api/v1/standards/GB%2015810-2019
Authorization: Bearer {token}
```

**响应参数（Response Data）：**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| standardNo | String | 标准编号 |
| standardName | String | 标准名称 |
| publishDate | String | 发布日期 |
| effectiveDate | String | 实施日期 |
| status | Integer | 状态（0=草稿，1=已发布） |
| foreword | String | 前言内容 |
| introduction | String | 引言内容 |
| scope | String | 范围内容 |
| normativeReferences | String | 规范性引用文件 |
| requirementItems | Array | **检验项目列表（核心嵌套数据）** |
| requirementItems[].itemId | Integer | 项目ID |
| requirementItems[].clauseNo | String | 项目条款号 |
| requirementItems[].itemName | String | 项目名称 |
| requirementItems[].requirement | String | 项目要求 |
| requirementItems[].methodContent | String | 检验方法内容 |
| requirementItems[].methodType | Integer | 方法类型 |
| requirementItems[].equipmentList | Array | **关联设备列表（二级嵌套）** |
| requirementItems[].equipmentList[].equipmentCode | String | 设备编号 |
| requirementItems[].equipmentList[].equipmentName | String | 设备名称 |
| requirementItems[].equipmentList[].category | String | 设备类别 |
| requirementItems[].equipmentList[].specificationRequirement | String | **规格要求（关键字段）** |
| termDefinitions | Array | 术语定义列表 |
| appendices | Array | 附录列表 |

**响应示例（成功）：**

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "standardNo": "GB 15810-2019",
    "standardName": "一次性使用无菌注射器",
    "publishDate": "2019-05-10",
    "effectiveDate": "2020-05-01",
    "status": 1,
    "foreword": "本标准按照GB/T 1.1-2009给出的规则起草...",
    "introduction": "本标准规定了一次性使用无菌注射器的要求...",
    "scope": "本标准规定了一次性使用无菌注射器的术语和定义...",
    "normativeReferences": "下列文件对于本文件的应用是必不可少的...",
    "requirementItems": [
      {
        "itemId": 1,
        "clauseNo": "5.7.1",
        "itemName": "残留容量",
        "requirement": "残留容量应不大于标称容量的5%或0.1mL（取较大值）",
        "methodContent": "使用分度值0.1mg的电子天平称量注射器...",
        "methodType": 3,
        "equipmentList": [
          {
            "equipmentCode": "A001",
            "equipmentName": "电子天平",
            "category": "天平类",
            "specificationRequirement": "分度值0.1mg"
          }
        ]
      },
      {
        "itemId": 2,
        "clauseNo": "5.7.2",
        "itemName": "器身密合性",
        "requirement": "器身密合性应符合附录B中B.2的要求",
        "methodContent": "按附录B中B.2规定的方法进行试验",
        "methodType": 2,
        "equipmentList": [
          {
            "equipmentCode": "B002",
            "equipmentName": "密合性测试仪",
            "category": "测试仪类",
            "specificationRequirement": "压力范围0-100kPa"
          },
          {
            "equipmentCode": "A001",
            "equipmentName": "电子天平",
            "category": "天平类",
            "specificationRequirement": "分度值0.01g"
          }
        ]
      }
    ],
    "termDefinitions": [
      {
        "termId": 1,
        "term": "标称容量",
        "definition": "注射器外筒上标示的容量值"
      }
    ],
    "appendices": [
      {
        "appendixId": 1,
        "appendixNo": "A",
        "appendixTitle": "附录A 试验方法",
        "appendixType": 1,
        "content": "A.1 试验设备\nA.2 试验步骤..."
      }
    ]
  },
  "timestamp": 1699876543210
}
```

**响应示例（失败 - 标准不存在）：**

```json
{
  "code": 404,
  "message": "标准不存在",
  "data": null,
  "timestamp": 1699876543210
}
```

**前端处理逻辑：**

```javascript
// 1. 查询标准详情
const standardNo = encodeURIComponent('GB 15810-2019');
const response = await axios.get(`/api/v1/standards/${standardNo}`);

const standard = response.data.data;

// 2. 渲染标准基本信息
renderStandardInfo(standard);

// 3. 渲染检验项目表格（包含设备信息）
standard.requirementItems.forEach(item => {
  // 渲染项目基本信息
  renderItemRow(item);

  // 渲染关联设备列表
  item.equipmentList.forEach(equipment => {
    // 显示设备名称和规格要求
    console.log(`${equipment.equipmentName}（${equipment.specificationRequirement}）`);
  });
});

// 4. 渲染术语定义
renderTermDefinitions(standard.termDefinitions);

// 5. 渲染附录
renderAppendices(standard.appendices);
```

**注意事项：**
1. standardNo需要URL编码（空格编码为%20）
2. 响应数据是深层嵌套结构，前端需要递归渲染
3. equipmentList可能为空数组（项目未关联设备）
4. specificationRequirement字段非常重要，用于显示设备的具体规格要求
5. 一个项目可能关联多个设备，每个设备有独立的规格要求

### 4.4 标准搜索

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 4.5 标准更新

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 4.6 标准删除

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 4.7 智能辅助联想接口 ⭐ 核心接口

**接口地址：** `GET /api/v1/standards/search/assist`

**业务说明：**
- PTR编辑时的智能辅助功能
- 用户输入项目名称关键词，系统返回标准库中的匹配结果
- **关键：requirementContent和methodContent必须分字段返回**
- 前端实现"点击分别插入"功能

**请求参数（Query String）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| keyword | String | 是 | 项目名称关键词 | 密封性 |
| limit | Integer | 否 | 返回结果数量限制 | 10（默认） |

**请求示例：**

```
GET /api/v1/standards/search/assist?keyword=密封性&limit=10
Authorization: Bearer {token}
```

**响应参数（Response Data）：**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| matches | Array | 匹配结果列表 |
| matches[].itemId | Integer | 项目ID |
| matches[].standardNo | String | 标准编号 |
| matches[].standardName | String | 标准名称 |
| matches[].clauseNo | String | 项目条款号 |
| matches[].itemName | String | 项目名称 |
| matches[].requirementContent | String | **项目要求内容（关键字段，单独返回）** |
| matches[].methodContent | String | **检验方法内容（关键字段，单独返回）** |
| matches[].methodType | Integer | 方法类型 |
| matches[].relevanceScore | Float | 相关度评分（0-1） |

**响应示例（成功）：**

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "matches": [
      {
        "itemId": 123,
        "standardNo": "GB 15810-2019",
        "standardName": "一次性使用无菌注射器",
        "clauseNo": "5.7.2",
        "itemName": "器身密合性",
        "requirementContent": "器身密合性应符合附录B中B.2的要求。在规定的试验条件下，注射器不应有泄漏现象。",
        "methodContent": "按附录B中B.2规定的方法进行试验。将注射器芯杆推至标称容量刻度，浸入水中，施加规定压力，保持30秒，观察是否有气泡产生。",
        "methodType": 2,
        "relevanceScore": 0.95
      },
      {
        "itemId": 456,
        "standardNo": "YY 0469-2023",
        "standardName": "医用外科口罩",
        "clauseNo": "4.5",
        "itemName": "密封性",
        "requirementContent": "口罩与面部的密封性应符合要求，泄漏率应不大于5%。",
        "methodContent": "采用密封性测试仪进行测试。受试者佩戴口罩，进行规定动作，测量口罩内外压力差，计算泄漏率。",
        "methodType": 3,
        "relevanceScore": 0.88
      },
      {
        "itemId": 789,
        "standardNo": "YY 0469-2023",
        "standardName": "医用外科口罩",
        "clauseNo": "4.6",
        "itemName": "鼻夹密封性",
        "requirementContent": "鼻夹应具有良好的可塑性，能够与面部紧密贴合。",
        "methodContent": "目测检查鼻夹形状，手动弯折鼻夹，观察其可塑性和回弹性。",
        "methodType": 1,
        "relevanceScore": 0.75
      }
    ]
  },
  "timestamp": 1699876543210
}
```

**响应示例（无匹配结果）：**

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "matches": []
  },
  "timestamp": 1699876543210
}
```

**前端处理逻辑：**

```javascript
// 1. 用户输入关键词，触发搜索
const keyword = '密封性';
const response = await axios.get(`/api/v1/standards/search/assist?keyword=${keyword}&limit=10`);

const matches = response.data.data.matches;

// 2. 在右侧辅助面板显示匹配结果
matches.forEach(match => {
  // 显示标准信息和项目名称
  console.log(`${match.standardNo} ${match.standardName} - ${match.itemName}`);

  // 3. 提供两个按钮：插入要求、插入方法
  const insertRequirementBtn = document.createElement('button');
  insertRequirementBtn.textContent = '插入要求';
  insertRequirementBtn.onclick = () => {
    // 插入requirementContent到编辑器
    editor.insertText(match.requirementContent);
  };

  const insertMethodBtn = document.createElement('button');
  insertMethodBtn.textContent = '插入方法';
  insertMethodBtn.onclick = () => {
    // 插入methodContent到编辑器
    editor.insertText(match.methodContent);
  };
});
```

**注意事项：**
1. requirementContent和methodContent必须分字段返回，不能合并
2. 前端需要提供两个独立的插入按钮
3. relevanceScore用于排序，相关度高的排在前面
4. 支持模糊匹配，不区分大小写
5. 建议使用防抖（debounce）优化搜索性能

### 4.8 检验方法查询

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

---

## 5. 设备管理接口

**说明：** 本模块接口均为简单CRUD操作，由Swagger自动生成，此处省略详细定义。

### 5.1 设备目录查询

### 5.2 设备详情查询

### 5.3 设备搜索

### 5.4 设备创建

### 5.5 设备更新

### 5.6 设备删除

### 5.7 项目设备关联查询

---

## 6. 错误报告接口

**说明：** 本模块接口均为简单CRUD操作，由Swagger自动生成，此处省略详细定义。

### 6.1 错误报告列表

### 6.2 错误报告详情

### 6.3 提交错误报告

### 6.4 处理错误报告

### 6.5 关闭错误报告

---

## 7. 数据导出接口

### 7.1 表格1导出

**说明：** 简单导出接口，由Swagger自动生成，此处省略。

### 7.2 认可检验检测能力表（表2）导出 ⭐ 核心接口

**接口地址：** `POST /api/v1/exports/table2`

**业务说明：**
- 设备管理人员导出认可检验检测能力表
- 支持复杂的两级筛选逻辑：设备大类 → 规格要求
- 返回Excel文件流（非JSON）

**请求参数（Request Body）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| standardNos | Array<String> | 否 | 标准编号列表（为空则导出所有） | ["GB 15810-2019"] |
| equipmentCode | String | 否 | 设备编号（一级筛选） | A001 |
| specRequirements | Array<String> | 否 | 规格要求列表（二级筛选，支持多选） | ["分度值0.1mg", "分度值0.01mg"] |

**请求示例：**

```json
{
  "standardNos": ["GB 15810-2019", "YY 0469-2023"],
  "equipmentCode": "A001",
  "specRequirements": ["分度值0.1mg", "分度值0.01mg"]
}
```

**响应格式：**

**Content-Type:** `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`

**Content-Disposition:** `attachment; filename="认可检验检测能力表_20231112.xlsx"`

**响应说明：**
- 返回二进制文件流（Blob），非JSON格式
- 前端需要使用Blob API处理下载

**Excel表格结构：**

| 列名 | 说明 | 示例 |
|------|------|------|
| 序号 | 自动编号 | 1 |
| 产品/项目/参数 | 项目名称 | 残留容量 |
| 依据的标准（方法）名称及编号 | 标准名称 + 标准编号 + 项目条款 | 一次性使用无菌注射器 GB 15810-2019 5.7.1 |
| 限制范围 | 空（预留字段） | - |
| 说明 | 使用设备（格式："设备名称（规格要求）"） | 电子天平（分度值0.1mg） |

**前端处理逻辑：**

```javascript
// 1. 发送导出请求
const response = await axios.post('/api/v1/exports/table2', {
  standardNos: ['GB 15810-2019'],
  equipmentCode: 'A001',
  specRequirements: ['分度值0.1mg', '分度值0.01mg']
}, {
  responseType: 'blob', // 关键：指定响应类型为blob
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});

// 2. 创建Blob对象
const blob = new Blob([response.data], {
  type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
});

// 3. 创建下载链接
const url = window.URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `认可检验检测能力表_${new Date().toISOString().slice(0, 10)}.xlsx`;

// 4. 触发下载
document.body.appendChild(link);
link.click();

// 5. 清理
document.body.removeChild(link);
window.URL.revokeObjectURL(url);
```

**筛选逻辑说明：**

1. **一级筛选（按设备大类）：**
   - 用户选择设备编号（如A001-电子天平）
   - 系统查询所有使用该设备的检验项目

2. **二级筛选（按规格要求）：**
   - 在一级筛选结果基础上，进一步筛选规格要求
   - 支持多选（如同时选择"分度值0.1mg"和"分度值0.01mg"）
   - 只导出匹配的规格要求的项目

**注意事项：**
1. 响应类型是Blob，不是JSON
2. 前端必须设置`responseType: 'blob'`
3. 文件名从响应头`Content-Disposition`中提取
4. 如果没有数据，返回空Excel文件（包含表头）
5. specRequirements为空数组时，导出该设备的所有规格

### 7.3 表格3导出

**说明：** 简单导出接口，由Swagger自动生成，此处省略。

### 7.4 自定义模板导出

**说明：** 简单导出接口，由Swagger自动生成，此处省略。

### 7.5 导出模板管理

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 7.6 导出历史查询

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

---

## 8. PTR编辑接口

### 8.1 获取模板列表

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 8.2 插入模板内容

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 8.3 智能内容推荐

**说明：** 已在4.7节定义（智能辅助联想接口），此处省略。

### 8.4 保存PTR文档

**说明：** 简单CRUD接口，由Swagger自动生成，此处省略。

### 8.5 PTR文档导出 ⭐ 核心接口

**接口地址：** `POST /api/v1/ptr/export`

**业务说明：**
- 将PTR文档导出为符合规范的Word文档
- 前端传递复杂的文档结构（章节树 + 富文本HTML）
- 后端使用Apache POI XWPF生成Word文件
- 返回二进制文件流（Blob），非JSON

**请求参数（Request Body）：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| documentId | Integer | 是 | PTR文档ID |
| productName | String | 是 | 产品名称 |
| modelSpec | String | 是 | 产品型号/规格及其划分说明 |
| chapters | Array | 是 | 章节列表（树形结构） |
| chapters[].chapterNo | String | 是 | 章节编号（如"1"、"2.1"、"2.1.1"） |
| chapters[].chapterTitle | String | 是 | 章节标题 |
| chapters[].chapterLevel | Integer | 是 | 章节层级（1/2/3） |
| chapters[].htmlContent | String | 是 | 富文本HTML内容 |
| chapters[].isEmpty | Boolean | 是 | 是否为空章节（空章节不输出标题） |

**请求示例：**

```json
{
  "documentId": 1,
  "productName": "一次性使用无菌注射器",
  "modelSpec": "1ml, 2ml, 5ml, 10ml, 20ml, 50ml",
  "chapters": [
    {
      "chapterNo": "1",
      "chapterTitle": "产品型号/规格及其划分说明",
      "chapterLevel": 1,
      "htmlContent": "<p>本产品按标称容量分为以下型号：</p><table><tr><th>型号</th><th>标称容量</th></tr><tr><td>1ml</td><td>1毫升</td></tr></table>",
      "isEmpty": false
    },
    {
      "chapterNo": "2",
      "chapterTitle": "性能指标",
      "chapterLevel": 1,
      "htmlContent": "<h2>2.1 残留容量</h2><p>残留容量应不大于标称容量的5%或0.1mL（取较大值）。</p><h2>2.2 器身密合性</h2><p>器身密合性应符合附录B中B.2的要求。</p>",
      "isEmpty": false
    },
    {
      "chapterNo": "3",
      "chapterTitle": "检验方法",
      "chapterLevel": 1,
      "htmlContent": "<h2>3.1 残留容量</h2><p>使用分度值0.1mg的电子天平称量...</p><h2>3.2 器身密合性</h2><p>按附录B中B.2规定的方法进行试验...</p>",
      "isEmpty": false
    },
    {
      "chapterNo": "4",
      "chapterTitle": "术语",
      "chapterLevel": 1,
      "htmlContent": "",
      "isEmpty": true
    },
    {
      "chapterNo": "5",
      "chapterTitle": "附录",
      "chapterLevel": 1,
      "htmlContent": "<h2>附录A 试验方法</h2><p>A.1 试验设备...</p>",
      "isEmpty": false
    }
  ]
}
```

**响应格式：**

**Content-Type:** `application/vnd.openxmlformats-officedocument.wordprocessingml.document`

**Content-Disposition:** `attachment; filename="产品技术要求_一次性使用无菌注射器_20231112.docx"`

**响应说明：**
- 返回二进制文件流（Blob），非JSON格式
- 前端需要使用Blob API处理下载

**Word文档格式要求：**

| 格式项 | 要求 |
|--------|------|
| 页面 | A4，边距2.54cm |
| 标题字体 | 宋体小二加粗居中 |
| 一级标题字体 | 宋体小四加粗左对齐 |
| 正文字体 | 宋体小四左对齐首行缩进2字符 |
| 行距 | 1.5倍 |
| 编号 | 一级1./2./3.，二级1.1/1.2，三级1.1.1/1.1.2 |
| 页码 | 页脚居中，格式"x/y"（如"1/9"） |
| 空章节 | 不输出标题 |
| 附录章节 | 前面分页 |

**前端处理逻辑：**

```javascript
// 1. 构建请求数据
const requestData = {
  documentId: 1,
  productName: '一次性使用无菌注射器',
  modelSpec: '1ml, 2ml, 5ml, 10ml, 20ml, 50ml',
  chapters: [
    // 从富文本编辑器提取章节数据
    {
      chapterNo: '1',
      chapterTitle: '产品型号/规格及其划分说明',
      chapterLevel: 1,
      htmlContent: editor.getChapterContent(1),
      isEmpty: editor.isChapterEmpty(1)
    },
    // ... 其他章节
  ]
};

// 2. 发送导出请求
const response = await axios.post('/api/v1/ptr/export', requestData, {
  responseType: 'blob', // 关键：指定响应类型为blob
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});

// 3. 创建Blob对象
const blob = new Blob([response.data], {
  type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
});

// 4. 创建下载链接
const url = window.URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `产品技术要求_${requestData.productName}_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.docx`;

// 5. 触发下载
document.body.appendChild(link);
link.click();

// 6. 清理
document.body.removeChild(link);
window.URL.revokeObjectURL(url);
```

**HTML到Word格式映射规则：**

| HTML标签 | Word格式 | 说明 |
|----------|----------|------|
| `<h1>` | 宋体小二加粗居中，编号1./2./3. | 一级标题 |
| `<h2>` | 宋体小四加粗左对齐，编号1.1/1.2 | 二级标题 |
| `<h3>` | 宋体小四加粗左对齐，编号1.1.1/1.1.2 | 三级标题 |
| `<p>` | 宋体小四左对齐首行缩进2字符行距1.5倍 | 段落 |
| `<table>` | 边框样式、表头加粗 | 表格 |
| `<strong>` / `<b>` | 加粗 | 文本格式 |
| `<em>` / `<i>` | 斜体 | 文本格式 |
| `<u>` | 下划线 | 文本格式 |

**注意事项：**
1. 响应类型是Blob，不是JSON
2. 前端必须设置`responseType: 'blob'`
3. htmlContent必须是合法的HTML字符串
4. 空章节（isEmpty=true）不输出章节标题
5. 附录章节前自动分页
6. 章节编号由后端自动生成，前端传递的chapterNo仅用于排序
7. 富文本HTML中的样式会被映射为Word格式

---

## 9. 系统管理接口

**说明：** 本模块接口均为简单CRUD操作，由Swagger自动生成，此处省略详细定义。

### 9.1 操作日志查询

### 9.2 系统配置查询

### 9.3 系统配置更新

---

## 附录

### 附录A：核心接口总结

本文档重点定义了以下6个核心接口（业务逻辑复杂、数据结构特殊、前后端交互风险高）：

| 序号 | 接口名称 | 接口地址 | 复杂度 | 关键点 |
|------|----------|----------|--------|--------|
| 1 | 用户登录接口 | POST /api/v1/auth/login | ⭐ | roleType自动识别，前端路由跳转 |
| 2 | 标准导入预览接口 | POST /api/v1/standards/import/preview | ⭐⭐⭐ | 红/黄/绿状态判定，设备智能识别 |
| 3 | 标准详情查询接口 | GET /api/v1/standards/{standardNo} | ⭐ | 深层嵌套结构，一次性获取所有数据 |
| 4 | 表2导出接口 | POST /api/v1/exports/table2 | ⭐⭐ | 两级筛选逻辑，返回Blob文件流 |
| 5 | PTR文档导出接口 | POST /api/v1/ptr/export | ⭐⭐⭐ | HTML到Word映射，复杂文档结构 |
| 6 | 智能辅助联想接口 | GET /api/v1/standards/search/assist | ⭐ | 分字段返回要求和方法 |

**其他简单CRUD接口由Swagger自动生成，不在本文档中详细定义。**

### 附录B：前端集成注意事项

#### B.1 文件下载处理（表2导出、PTR导出）

```javascript
// 统一的文件下载处理函数
async function downloadFile(url, requestData, filename) {
  const response = await axios.post(url, requestData, {
    responseType: 'blob', // 关键：必须设置为blob
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`,
      'Content-Type': 'application/json'
    }
  });

  // 创建Blob对象
  const blob = new Blob([response.data]);

  // 创建下载链接
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;

  // 触发下载
  document.body.appendChild(link);
  link.click();

  // 清理
  document.body.removeChild(link);
  window.URL.revokeObjectURL(url);
}
```

#### B.2 状态码统一处理

```javascript
// Axios响应拦截器
axios.interceptors.response.use(
  response => {
    const { code, message } = response.data;

    // 成功
    if (code === 200) {
      return response;
    }

    // 业务错误
    if (code >= 1000 && code < 2000) {
      // 认证错误
      if (code === 1001 || code === 1002 || code === 1003) {
        // 跳转到登录页
        router.push('/login');
      }
      ElMessage.error(message);
      return Promise.reject(new Error(message));
    }

    // 文件处理错误
    if (code >= 2000 && code < 3000) {
      ElMessage.error(message);
      return Promise.reject(new Error(message));
    }

    // 数据库错误
    if (code >= 3000 && code < 4000) {
      ElMessage.error('数据库操作失败，请联系管理员');
      return Promise.reject(new Error(message));
    }

    // 系统错误
    if (code >= 5000) {
      ElMessage.error('系统错误，请联系管理员');
      return Promise.reject(new Error(message));
    }

    return response;
  },
  error => {
    ElMessage.error('网络错误，请检查网络连接');
    return Promise.reject(error);
  }
);
```

#### B.3 导入预览状态渲染

```vue
<template>
  <el-table :data="items" :row-class-name="getRowClassName">
    <el-table-column prop="itemName" label="项目名称" />
    <el-table-column prop="equipmentName" label="设备名称">
      <template #default="{ row }">
        <el-tooltip v-if="row.status !== 1" :content="row.warningMsg">
          <span :class="getStatusClass(row.status)">
            {{ row.equipmentName || '未识别' }}
          </span>
        </el-tooltip>
        <span v-else>{{ row.equipmentName }}</span>
      </template>
    </el-table-column>
  </el-table>
</template>

<script setup>
const getRowClassName = ({ row }) => {
  switch (row.status) {
    case 1: return 'success-row';
    case 2: return 'warning-row';
    case 3: return 'error-row';
    default: return '';
  }
};

const getStatusClass = (status) => {
  switch (status) {
    case 1: return 'status-success';
    case 2: return 'status-warning';
    case 3: return 'status-error';
    default: return '';
  }
};
</script>

<style scoped>
.success-row {
  background-color: #f0f9ff;
}
.warning-row {
  background-color: #fffbeb;
}
.error-row {
  background-color: #fef2f2;
}
.status-success {
  color: #10b981;
}
.status-warning {
  color: #f59e0b;
}
.status-error {
  color: #ef4444;
}
</style>
```

### 附录C：后端实现参考

#### C.1 EasyExcel解析示例

```java
@Service
public class StandardImportService {

    @Autowired
    private EquipmentKeywordService equipmentKeywordService;

    public ImportPreviewDTO parseExcel(MultipartFile file) {
        try {
            // 使用EasyExcel流式读取
            List<StandardItemDTO> items = new ArrayList<>();

            EasyExcel.read(file.getInputStream(), StandardItemExcelVO.class,
                new AnalysisEventListener<StandardItemExcelVO>() {
                    @Override
                    public void invoke(StandardItemExcelVO data, AnalysisContext context) {
                        // 解析每一行
                        StandardItemDTO item = convertToDTO(data);

                        // 设备关键词识别
                        EquipmentMatchResult matchResult =
                            equipmentKeywordService.matchEquipment(item.getMethodContent());

                        // 设置状态
                        if (matchResult.isMatched()) {
                            if (matchResult.isExisting()) {
                                item.setStatus(1); // 绿色：成功
                                item.setStatusColor("green");
                                item.setWarningMsg("自动识别成功");
                            } else {
                                item.setStatus(2); // 黄色：警告
                                item.setStatusColor("yellow");
                                item.setWarningMsg("识别到新设备：" + matchResult.getEquipmentName() + "，请确认是否添加到设备库");
                            }
                            item.setEquipmentMatch(matchResult.getEquipment());
                        } else {
                            item.setStatus(3); // 红色：错误
                            item.setStatusColor("red");
                            item.setWarningMsg("未识别到设备关键词，请人工补充设备信息");
                        }

                        items.add(item);
                    }

                    @Override
                    public void doAfterAllAnalysed(AnalysisContext context) {
                        // 解析完成
                    }
                }).sheet().doRead();

            // 构建响应
            ImportPreviewDTO preview = new ImportPreviewDTO();
            preview.setItems(items);
            preview.setStatistics(calculateStatistics(items));

            return preview;

        } catch (IOException e) {
            throw new BusinessException(2005, "Excel解析失败：" + e.getMessage());
        }
    }
}
```

#### C.2 Apache POI XWPF Word生成示例

```java
@Service
public class PTRExportService {

    public byte[] generateWordDocument(PTRExportDTO exportDTO) {
        try (XWPFDocument document = new XWPFDocument()) {

            // 设置页面
            CTSectPr sectPr = document.getDocument().getBody().addNewSectPr();
            CTPageSz pageSize = sectPr.addNewPgSz();
            pageSize.setW(BigInteger.valueOf(11906)); // A4宽度
            pageSize.setH(BigInteger.valueOf(16838)); // A4高度

            // 添加标题
            XWPFParagraph titlePara = document.createParagraph();
            titlePara.setAlignment(ParagraphAlignment.CENTER);
            XWPFRun titleRun = titlePara.createRun();
            titleRun.setText(exportDTO.getProductName() + " 产品技术要求");
            titleRun.setFontFamily("宋体");
            titleRun.setFontSize(18);
            titleRun.setBold(true);

            // 遍历章节
            for (ChapterDTO chapter : exportDTO.getChapters()) {
                if (chapter.getIsEmpty()) {
                    continue; // 跳过空章节
                }

                // 附录章节前分页
                if (chapter.getChapterNo().startsWith("附录")) {
                    document.createParagraph().setPageBreak(true);
                }

                // 添加章节标题
                XWPFParagraph chapterPara = document.createParagraph();
                XWPFRun chapterRun = chapterPara.createRun();
                chapterRun.setText(chapter.getChapterNo() + " " + chapter.getChapterTitle());
                chapterRun.setFontFamily("宋体");
                chapterRun.setFontSize(14);
                chapterRun.setBold(true);

                // 解析HTML内容并添加到Word
                parseHtmlToWord(document, chapter.getHtmlContent());
            }

            // 添加页码
            addPageNumbers(document);

            // 转换为字节数组
            ByteArrayOutputStream out = new ByteArrayOutputStream();
            document.write(out);
            return out.toByteArray();

        } catch (IOException e) {
            throw new BusinessException(2006, "Word生成失败：" + e.getMessage());
        }
    }

    private void parseHtmlToWord(XWPFDocument document, String htmlContent) {
        // 使用Jsoup解析HTML
        Document doc = Jsoup.parse(htmlContent);
        Elements elements = doc.body().children();

        for (Element element : elements) {
            if (element.tagName().equals("p")) {
                // 段落
                XWPFParagraph para = document.createParagraph();
                para.setIndentationFirstLine(567); // 首行缩进2字符
                XWPFRun run = para.createRun();
                run.setText(element.text());
                run.setFontFamily("宋体");
                run.setFontSize(12);
            } else if (element.tagName().equals("table")) {
                // 表格
                parseTableToWord(document, element);
            }
            // ... 其他HTML标签处理
        }
    }
}
```

### 附录D：接口变更记录

| 日期 | 接口 | 变更类型 | 变更内容 | 影响范围 |
|------|------|----------|----------|----------|
| 2025-11-12 | - | 新增 | 初始版本，定义6个核心接口 | 全部 |
| 2025-11-14 | - | 更新 | 更新技术栈版本说明（Spring Boot 3.5.7、Java 17等） | 文档说明 |

---

## 文档修订历史

| 版本 | 日期 | 修订人 | 修订内容 | 审核人 |
|------|------|--------|----------|--------|
| v1.0 | 2025-11-12 | AI架构师 | 创建文档，定义6个核心接口（登录、导入预览、标准详情、表2导出、PTR导出、智能联想） | - |
| v2.0 | 2025-11-14 | AI架构师 | 更新技术栈版本：Spring Boot 3.5.7、Java 17、MyBatis-Plus 3.5.9、Vue 3.3.4、Element Plus 2.4.2、Vite 4.4.9 | - |

